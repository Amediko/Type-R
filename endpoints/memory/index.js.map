{"version":3,"file":"index.js","sources":["../../src/io-tools.ts","../../src/endpoints/memory.ts"],"sourcesContent":["export interface IONode {\n    _endpoint : IOEndpoint\n    _ioPromise : IOPromise< any >\n}\n\nexport interface IOPromise<T> extends Promise<T> {\n    abort() : void\n}\n\nexport interface IOEndpoint {\n    list( options : object ) : IOPromise<any>\n    create( json : any, options : object ) : IOPromise<any>\n    update( id : string | number, json :any, options : object ) : IOPromise<any>\n    read( id : string | number, options : object ) : IOPromise<any>\n    destroy( id : string | number, options : object ) : IOPromise<any>\n    subscribe( events : IOEvents ) : IOPromise<any>\n    unsubscribe( events : IOEvents ) : void\n}\n\nexport interface IOEvents {\n    updated? : ( json : any ) => void\n    removed? : ( json : any ) => void\n}\n\nexport function getOwnerEndpoint( self ) : IOEndpoint {\n    // Check if we are the member of the collection...\n    const { collection } = self;\n    if( collection ){\n        return getOwnerEndpoint( collection );\n    }\n\n    // Now, if we're the member of the model...\n    if( self._owner ){\n        const { _endpoints } = self._owner;\n        return _endpoints && _endpoints[ self._ownerKey ];\n    }\n}\n\n/**\n * Create abortable promise.\n * Adds `promise.abort()` function which rejects the promise by default\n * initialize() function takes third optional argument `abort : ( resolve, reject ) => void`,\n * which can be used to add custom abort handling.\n */\ndeclare var Promise: PromiseConstructorLike;\n\nexport function createIOPromise( initialize : InitIOPromise ) : IOPromise<any>{\n    let resolve, reject, onAbort;\n\n    function abort( fn ){\n        onAbort = fn;\n    }\n\n    const promise : IOPromise<any> = new Promise( ( a_resolve, a_reject ) =>{\n        reject = a_reject;\n        resolve = a_resolve;\n        initialize( resolve, reject, abort );\n    }) as IOPromise<any>;\n\n    promise.abort = () => {\n        onAbort ? onAbort( resolve, reject ) : reject( new Error( \"I/O Aborted\" ) );\n    }\n\n    return promise;\n}\n\nexport type InitIOPromise = ( resolve : ( x? : any ) => void, reject : ( x? : any ) => void, abort? : ( fn : Function ) => void ) => void;\n\nexport function startIO( self : IONode, promise : IOPromise<any>, options : object, thenDo : ( json : any ) => any ) : IOPromise<any> {\n    // Stop pending I/O first...\n    abortIO( self );\n    \n    self._ioPromise = promise\n        .then( resp => {\n            self._ioPromise = null;\n    \n            const result = thenDo ? thenDo( resp ) : resp;\n                \n            triggerAndBubble( self, 'sync', self, resp, options );\n                \n            return result;\n        } )  \n        .catch( err => {\n            self._ioPromise = null;\n\n            console.error( err );\n            \n            triggerAndBubble( self, 'error', self, err, options );\n            \n            throw err;\n        } ) as IOPromise<any>;\n\n    self._ioPromise.abort = promise.abort;\n\n    return self._ioPromise;\n}\n\nexport function abortIO( self : IONode ){\n    if( self._ioPromise && self._ioPromise.abort ){\n        self._ioPromise.abort();\n        self._ioPromise = null;\n    }\n}\n\nexport function triggerAndBubble( eventSource, ...args ){\n    eventSource.trigger.apply( eventSource, args );\n    const { collection } = eventSource;\n    collection && collection.trigger.apply( collection, args ); \n}","import { IOEndpoint, IOPromise, createIOPromise } from '../io-tools'\n\nexport type Index = number[];\n\nexport function create( delay = 1000 ){\n    return new MemoryEndpoint( delay );\n}\n\nexport { create as memoryIO };\n\nexport class MemoryEndpoint implements IOEndpoint {\n    static create( delay = 1000 ){\n        return new this( delay );\n    }\n\n    resolve( value ){\n        return createIOPromise( ( resolve, reject ) => {\n            setTimeout( () => resolve( value ), this.delay );\n        });\n    }\n    \n    reject( value ){\n        return createIOPromise( ( resolve, reject ) => {\n            setTimeout( () => reject( value ), this.delay );\n        });\n    }\n\n    constructor( public delay : number ){\n    }\n\n    index = [ 0 ];\n    items = {};\n\n    generateId(){\n        return this.index[ 0 ]++;\n    }\n\n    create( json, options ) {\n        const id = json.id = this.generateId();\n        this.index.push( id );\n        this.items[ id ] = json;\n        return this.resolve({ id });\n    }\n\n    update( id, json, options ) {\n        const existing = this.items[ id ];\n        if( existing ){\n            this.items[ id ] = json;\n            return this.resolve( {} );\n        }\n        else{\n            return this.reject( \"Not found\");\n        }\n    }\n\n    read( id, options ){\n        const existing = this.items[ id ];\n        return existing ?\n            this.resolve( existing ) : \n            this.reject( \"Not found\" );\n    }\n\n    destroy( id, options ){\n        const existing = this.items[ id ];\n        if( existing ){\n            delete this.items[ id ];\n            this.index = this.index.filter( x => x !== id );\n            return this.resolve( {} );\n        }\n        else{\n            return this.reject( \"Not found\" );\n        }\n    }\n\n    list( options? : object ) {\n        return this.resolve( this.index );\n    }\n\n    subscribe( events ) : any {}\n    unsubscribe( events) : any {}\n}"],"names":["initialize","fn","onAbort","resolve","reject","promise","Promise","a_resolve","a_reject","abort","Error","delay","MemoryEndpoint","this","value","createIOPromise","setTimeout","_this","index","json","options","id","generateId","push","items","existing","filter","x","events"],"mappings":"sMA8CiCA,GAG7B,WAAgBC,GACZC,EAAUD,EAHd,IAAIE,EAASC,EAAQF,EAMfG,EAA2B,IAAIC,QAAS,SAAEC,EAAWC,GAGvDR,EADAG,EAAUI,EADVH,EAASI,EAEoBC,KAOjC,OAJAJ,EAAQI,MAAQ,WACZP,EAAUA,EAASC,EAASC,GAAWA,EAAQ,IAAIM,MAAO,iBAGvDL,aC3DaM,GACpB,oBADoBA,OACb,IAAIC,EAAgBD,GAG/B,iBAmBI,WAAoBA,GAAAE,WAAAF,EAGpBE,YAAU,GACVA,cAiDJ,OArEWD,SAAP,SAAeD,GACX,oBADWA,OACJ,IAAIE,KAAMF,IAGrBC,oBAAA,SAASE,GAAT,WACI,OAAOC,EAAiB,SAAEZ,EAASC,GAC/BY,WAAY,WAAM,OAAAb,EAASW,IAASG,EAAKN,UAIjDC,mBAAA,SAAQE,GAAR,WACI,OAAOC,EAAiB,SAAEZ,EAASC,GAC/BY,WAAY,WAAM,OAAAZ,EAAQU,IAASG,EAAKN,UAUhDC,uBAAA,WACI,OAAOC,KAAKK,MAAO,MAGvBN,mBAAA,SAAQO,EAAMC,GACV,IAAMC,EAAKF,EAAKE,GAAKR,KAAKS,aAG1B,OAFAT,KAAKK,MAAMK,KAAMF,GACjBR,KAAKW,MAAOH,GAAOF,EACZN,KAAKV,SAAUkB,QAG1BT,mBAAA,SAAQS,EAAIF,EAAMC,GAEd,OADiBP,KAAKW,MAAOH,IAEzBR,KAAKW,MAAOH,GAAOF,EACZN,KAAKV,aAGLU,KAAKT,OAAQ,cAI5BQ,iBAAA,SAAMS,EAAID,GACN,IAAMK,EAAWZ,KAAKW,MAAOH,GAC7B,OAAOI,EACHZ,KAAKV,QAASsB,GACdZ,KAAKT,OAAQ,cAGrBQ,oBAAA,SAASS,EAAID,GAET,OADiBP,KAAKW,MAAOH,WAElBR,KAAKW,MAAOH,GACnBR,KAAKK,MAAQL,KAAKK,MAAMQ,OAAQ,SAAAC,GAAK,OAAAA,IAAMN,IACpCR,KAAKV,aAGLU,KAAKT,OAAQ,cAI5BQ,iBAAA,SAAMQ,GACF,OAAOP,KAAKV,QAASU,KAAKK,QAG9BN,sBAAA,SAAWgB,KACXhB,wBAAA,SAAagB"}